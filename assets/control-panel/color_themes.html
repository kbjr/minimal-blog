
<main>
	<h1>{{ labels.pages.color_themes.title }}</h1>
	<!-- fixme: i18n -->
	<p class="helper-text">
		These settings control the color themes - both light and dark - for the main website. (They do
		not control the color themes used in this control panel.)
	</p>

	<div id="main-panel">
		<!-- Select Active Themes -->
		<section id="sec-themes-select">
			<h3>{{ labels.pages.color_themes.select_subtitle }}</h3>
		
			<form id="form-themes-select" aria-busy="true" aria-live="polite">
				<label for="in-themes-select-light">{{ labels.pages.color_themes.select_label_light_mode }}</label>
				<select id="in-themes-select-light" disabled>
					<option value="">{{ labels.loading }}</option>
				</select>
		
				<label for="in-themes-select-dark">{{ labels.pages.color_themes.select_label_dark_mode }}</label>
				<select id="in-themes-select-dark" disabled>
					<option value="">{{ labels.loading }}</option>
				</select>
		
				<div data-flex="row align-center">
					<button type="submit" id="btn-themes-select" disabled>{{ labels.pages.color_themes.select_update }}</button>
				</div>
			</form>
		</section>
	
		<!-- Create New Theme -->
		<section id="sec-themes-create">
			<h3>{{ labels.pages.color_themes.create_subtitle }}</h3>
		
			<form id="form-themes-create" aria-busy="true" aria-live="polite">
				<label for="in-themes-create-start-from">{{ labels.pages.color_themes.create_label_start_from }}</label>
				<select id="in-themes-create-start-from" disabled>
					<option value="">{{ labels.loading }}</option>
				</select>
		
				<label for="in-themes-create-name">{{ labels.pages.color_themes.create_label_new_name }}</label>
				<input type="text" id="in-themes-create-name" required>
		
				<div data-flex="row align-center">
					<button type="submit" id="btn-themes-create" disabled>{{ labels.pages.color_themes.create_theme }}</button>
				</div>
			</form>
		</section>
	
		<!-- Import Theme From File -->
		<section id="sec-themes-import">
			<!-- fixme: i18n label -->
			<h3>Import Color Theme</h3>
		
			<form id="form-themes-import" aria-busy="true" aria-live="polite">
				<!-- fixme: i18n label -->
				<label for="in-themes-import">Select Theme File to Import</label>
				<input type="file" accept="application/json" id="in-themes-import" required>
		
				<div data-flex="row align-center">
					<!-- fixme: i18n label -->
					<button type="submit" id="btn-themes-import" disabled>Import</button>
				</div>
			</form>
		</section>
	
		<!-- Export Theme To File -->
		<section id="sec-themes-export">
			<!-- fixme: i18n label -->
			<h3>Export Color Theme</h3>
		
			<form id="form-themes-export" aria-busy="true" aria-live="polite">
				<!-- fixme: i18n label -->
				<label for="in-themes-select-export">Select Theme to Export</label>
				<select id="in-themes-select-export" disabled>
					<option value="">{{ labels.loading }}</option>
				</select>
		
				<div data-flex="row align-center">
					<!-- fixme: i18n label -->
					<button type="submit" id="btn-themes-export" disabled>Export</button>
				</div>
			</form>
		</section>
		
		<!-- Edit Colors in a Theme -->
		<section id="sec-themes-edit">
			<h3>{{ labels.pages.color_themes.edit_subtitle }}</h3>
		
			<form id="form-themes-edit" aria-busy="true" aria-live="polite">
				<label for="in-themes-edit">{{ labels.pages.color_themes.edit_label_theme }}</label>
				<select id="in-themes-edit" disabled>
					<option value="">{{ labels.loading }}</option>
				</select>
		
				<div data-flex="row align-center">
					<button type="button" id="btn-themes-delete" disabled data-style="secondary">{{ labels.pages.color_themes.delete_theme }}</button>
					<button type="submit" id="btn-themes-edit" disabled>
						<span>{{ labels.pages.color_themes.edit_colors }}</span>
						{{{ icons.arrow-down }}}
					</button>
				</div>
			</form>
		</section>
	</div>

	<!-- Color Pickers -->
	<div id="edit-colors-panel">
		<section id="sec-edit-colors" disabled aria-disabled="true">
			<h3>Edit Colors</h3>

			<form id="form-themes-edit-colors" aria-busy="true" aria-live="polite">
				<section>
					<h4>Basics</h4>
					<ul>
						<li><color-input disabled data-color="bg_main"></color-input></li>
						<li><color-input disabled data-color="bg_light"></color-input></li>
						<li><color-input disabled data-color="bg_heavy"></color-input></li>
						<li><color-input disabled data-color="line"></color-input></li>
						<li><color-input disabled data-color="sun"></color-input></li>
						<li><color-input disabled data-color="moon"></color-input></li>
					</ul>
				</section>

				<section>
					<h4>Text</h4>
					<ul>
						<li><color-input disabled data-color="text_heading"></color-input></li>
						<li><color-input disabled data-color="text_body"></color-input></li>
						<li><color-input disabled data-color="text_light"></color-input></li>
						<li><color-input disabled data-color="text_link"></color-input></li>
						<li><color-input disabled data-color="text_link_active"></color-input></li>
						<li><color-input disabled data-color="text_link_visited"></color-input></li>
						<li><color-input disabled data-color="text_highlight"></color-input></li>
						<li><color-input disabled data-color="bg_text_highlight"></color-input></li>
						<li><color-input disabled data-color="text_selection"></color-input></li>
						<li><color-input disabled data-color="bg_text_selection"></color-input></li>
					</ul>
				</section>

				<section>
					<h4>Buttons</h4>
					<ul>
						<li><color-input disabled data-color="bg_button_primary"></color-input></li>
						<li><color-input disabled data-color="bg_button_primary_hover"></color-input></li>
						<li><color-input disabled data-color="text_button_primary"></color-input></li>
						<li><color-input disabled data-color="bg_button_secondary"></color-input></li>
						<li><color-input disabled data-color="bg_button_secondary_hover"></color-input></li>
						<li><color-input disabled data-color="text_button_secondary"></color-input></li>
					</ul>
				</section>

				<section>
					<h4>Inputs</h4>
					<ul>
						<li><color-input disabled data-color="bg_input"></color-input></li>
						<li><color-input disabled data-color="border_input"></color-input></li>
						<li><color-input disabled data-color="border_input_invalid"></color-input></li>
					</ul>
				</section>

				<section>
					<h4>Code Snippets</h4>
					<ul>
						<li><color-input disabled data-color="code_normal"></color-input></li>
						<li><color-input disabled data-color="code_shadow"></color-input></li>
						<li><color-input disabled data-color="code_background"></color-input></li>
						<li><color-input disabled data-color="code_selection"></color-input></li>
						<li><color-input disabled data-color="code_comment"></color-input></li>
						<li><color-input disabled data-color="code_punc"></color-input></li>
						<li><color-input disabled data-color="code_operator"></color-input></li>
						<li><color-input disabled data-color="code_const_literal"></color-input></li>
						<li><color-input disabled data-color="code_number_literal"></color-input></li>
						<li><color-input disabled data-color="code_boolean_literal"></color-input></li>
						<li><color-input disabled data-color="code_tag"></color-input></li>
						<li><color-input disabled data-color="code_string"></color-input></li>
						<li><color-input disabled data-color="code_keyword"></color-input></li>
						<li><color-input disabled data-color="code_func_name"></color-input></li>
						<li><color-input disabled data-color="code_class_name"></color-input></li>
						<li><color-input disabled data-color="code_regex_important"></color-input></li>
						<li><color-input disabled data-color="code_variable"></color-input></li>
						<li><color-input disabled data-color="code_builtin"></color-input></li>
						<li><color-input disabled data-color="code_attr_name"></color-input></li>
						<li><color-input disabled data-color="code_gutter_divider"></color-input></li>
						<li><color-input disabled data-color="code_line_number"></color-input></li>
						<li><color-input disabled data-color="code_line_highlight"></color-input></li>
					</ul>
				</section>

				<div data-flex="row align-center">
					<button type="reset" id="btn-theme-edit-cancel" data-style="secondary">
						{{{ icons.arrow-up }}}
						<span>Back</span>
					</button>
					<button type="submit" id="btn-theme-edit-save">Save Changes</button>
				</div>
			</form>
		</section>
	</div>
</main>

<script>
	{{> color_input }}
</script>

<script>
(async () => {

let themes;
let settings;
let theme_being_edited;
let theme_edits;

const exported_color_theme_uuid = '6b9736da-e6f8-11ec-82bd-00155d93d186';



// ===== Elements =====

const heading = document.querySelector('main > h1');
const edit_colors_panel = document.querySelector('#edit-colors-panel');

const form_select = document.querySelector('#form-themes-select');
const select_light_theme = document.querySelector('#in-themes-select-light');
const select_dark_theme = document.querySelector('#in-themes-select-dark');
const button_select = document.querySelector('#btn-themes-select');

const form_create = document.querySelector('#form-themes-create');
const select_create_from = document.querySelector('#in-themes-create-start-from');
const input_create_name = document.querySelector('#in-themes-create-name');
const button_create = document.querySelector('#btn-themes-create');

const form_import = document.querySelector('#form-themes-import');
const input_import = document.querySelector('#in-themes-import');
const button_import = document.querySelector('#btn-themes-import');

const form_export = document.querySelector('#form-themes-export');
const select_export = document.querySelector('#in-themes-select-export');
const button_export = document.querySelector('#btn-themes-export');

const form_edit = document.querySelector('#form-themes-edit');
const select_edit = document.querySelector('#in-themes-edit');
const button_edit = document.querySelector('#btn-themes-edit');
const button_delete = document.querySelector('#btn-themes-delete');

const form_edit_colors = document.querySelector('#form-themes-edit-colors');
const color_editor = document.querySelector('#sec-edit-colors');
const color_inputs = document.querySelectorAll('color-input');



// ===== Bind Events =====

form_select.addEventListener('submit', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	const light_theme = select_light_theme.value;
	const dark_theme = select_dark_theme.value;

	disable_form(form_select);
	submit_select(light_theme, dark_theme);

	return false;
});

form_create.addEventListener('submit', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	const start_from = select_create_from.value;
	const new_name = input_create_name.value;

	disable_form(form_create);
	submit_create(start_from, new_name);

	return false;
});

form_edit.addEventListener('submit', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	const theme = select_edit.value;

	if (! theme) {
		// TODO: Error
		return false;
	}

	disable_form(form_edit);
	theme_edits = { };
	theme_being_edited = theme;
	reload_color_inputs();
	enable_color_editor();

	edit_colors_panel.scrollIntoView({
		behavior: 'smooth',
		block: 'start',
	});

	return false;
});

form_export.addEventListener('submit', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	const theme = select_export.value;

	if (! theme || ! themes[theme]) {
		// TODO: Error
		return false;
	}

	export_color_theme(theme);

	return false;
})

button_delete.addEventListener('click', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	const theme = select_edit.value;

	if (! theme) {
		// TODO: Error
		return false;
	}

	disable_form(form_edit);
	submit_delete(theme);

	return false;
});

form_edit_colors.addEventListener('submit', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	disable_color_editor();
	submit_edit_save();

	return false;
});

form_edit_colors.addEventListener('reset', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	theme_edits = null;
	theme_being_edited = null;
	reload_color_inputs();
	disable_color_editor();
	enable_form(form_edit);

	heading.scrollIntoView({
		behavior: 'smooth',
		block: 'start',
	});

	return false;
});

for (const input of color_inputs) {
	input.addEventListener('change', (event) => {
		const name = input.color;
		const value = event.detail.new_value;

		if (value === original_color_value(name)) {
			delete theme_edits[name];
		}

		else {
			theme_edits[name] = value;
		}
	});
}



// ===== Start Loading Data =====

load();



// ===== Utility Functions =====

async function load() {
	[ themes, settings ] = await Promise.all([
		app.http_get('/api/themes', true),
		app.http_get('/api/settings', true),
	]);

	select_create_from.innerHTML = '';
	select_light_theme.innerHTML = '';
	select_dark_theme.innerHTML = '';
	select_edit.innerHTML = '';
	select_export.innerHTML = '';

	for (const [name, colors] of Object.entries(themes)) {
		append_option(select_light_theme, name, settings.theme_light === name);
		append_option(select_dark_theme, name, settings.theme_dark === name);
		append_option(select_create_from, name, settings.theme_light === name);
		append_option(select_export, name, settings.theme_light === name);

		if (colors.$builtin) {
			// pass: cannot edit or delete builtin themes
		}
		
		else {
			append_option(select_edit, name, settings.theme_light === name);
		}
	}

	form_select.setAttribute('aria-busy', 'false');
	form_create.setAttribute('aria-busy', 'false');
	form_edit.setAttribute('aria-busy', 'false');
	form_export.setAttribute('aria-busy', 'false');
	form_import.setAttribute('aria-busy', 'false');
	form_edit_colors.setAttribute('aria-busy', 'false');

	select_create_from.disabled = false;
	select_light_theme.disabled = false;
	select_dark_theme.disabled = false;
	select_export.disabled = false;
	select_edit.disabled = false;

	button_create.disabled = false;
	button_select.disabled = false;
	button_edit.disabled = false;
	button_export.disabled = false;
	button_import.disabled = false;
	button_delete.disabled = false;

	reload_color_inputs();
}

function append_option(to, name, select) {
	const opt = document.createElement('option');
	opt.value = name;
	opt.innerHTML = name; // TODO: Sanitize
	opt.selected = select;
	to.appendChild(opt);
	return opt;
}

function disable_form(form, busy = true) {
	const inputs = form.querySelectorAll('input, select, button, color-input');

	if (busy) {
		form.setAttribute('aria-busy', 'true');
	}

	for (const input of inputs) {
		input.disabled = true;
	}
}

function enable_form(form, unbusy = true) {
	const inputs = form.querySelectorAll('input, select, button, color-input');

	if (unbusy) {
		form.setAttribute('aria-busy', 'false');
	}

	for (const input of inputs) {
		input.disabled = false;
	}
}

function disable_color_editor() {
	color_editor.setAttribute('disabled', '');
	color_editor.setAttribute('aria-disabled', 'true');
	disable_form(form_edit_colors);
}

function enable_color_editor() {
	color_editor.removeAttribute('disabled');
	color_editor.removeAttribute('aria-disabled');
	enable_form(form_edit_colors);
}

function reload_color_input(input) {
	input.color_name.innerHTML = input.color;

	if (input.edited_value) {
		input.value = input.edited_value;
		return;
	}

	if (themes && theme_being_edited) {
		const theme = themes[theme_being_edited];

		if (theme) {
			input.value = theme[input.color];
			return;
		}
	}

	input.value = null;
}

function original_color_value(name) {
	return themes && themes[theme_being_edited] && themes[theme_being_edited][name];
}

function reload_color_inputs() {
	for (const input of color_inputs) {
		reload_color_input(input);
	}
}

async function submit_select(theme_light, theme_dark) {
	try {
		await app.http_patch('/api/settings', true, { theme_light, theme_dark });
	}

	catch (error) {
		// TODO: Tell the user what went wrong
		enable_form(form_select);
		return;
	}
	
	enable_form(form_select);
	settings.theme_light = theme_light;
	settings.theme_dark = theme_dark;
}

async function submit_create(base_name, theme_name) {
	let new_theme;

	try {
		new_theme = await app.http_post('/api/themes', true, { base_name, theme_name });
	}

	catch (error) {
		// TODO: Tell the user what went wrong
		enable_form(form_create);
		return;
	}

	enable_form(form_create);
	input_create_name.value = '';

	themes[theme_name] = new_theme;

	append_option(select_light_theme, theme_name, false);
	append_option(select_dark_theme, theme_name, false);
	append_option(select_create_from, theme_name, false);
	append_option(select_edit, theme_name, false);
}

async function submit_delete(theme_name) {
	// TODO: Delete theme
}

async function submit_edit_save() {
	disable_color_editor();

	const new_theme_version = { };
	Object.assign(new_theme_version, themes[theme_being_edited]);
	Object.assign(new_theme_version, theme_edits);

	try {
		// TODO: Save updates...
	}

	catch (error) {
		// TODO: Tell the user what went wrong
		enable_color_editor();
		return;
	}

	Object.assign(themes[theme_being_edited], theme_edits);
	theme_edits = { };
	enable_color_editor();
}

const schema_uri = 'https://raw.githubusercontent.com/kbjr/minimal-blog/master/color-theme.schema.json';

function import_color_theme(json) {
	const obj = JSON.parse(json);
	// 
}

function export_color_theme(name) {
	const colors = Object.assign({ }, themes[name]);
	delete colors.$builtin;

	const obj = { $schema: schema_uri, name, colors };
	const json = JSON.stringify(obj, null, 2);

	app.download_file('application/json', json, `${name}.theme.json`);
}

})();
</script>

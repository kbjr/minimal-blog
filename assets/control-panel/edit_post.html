
<main>
	<form id="form-edit-post">
		<h1>{{ labels.pages.create_new_post.title }}</h1>

		{{# page.is_new }}
		<label for="in-post-title">Post Title <sup>*</sup></label>
		<input type="text" id="in-post-title" autofocus required>
		<p id="post-url">Post URL: {{ site.url }}/posts/<span></span></p>
		{{/ page.is_new }}
		
		{{^ page.is_new }}
		<label for="in-post-title">Post Title <sup>*</sup></label>
		<input type="text" id="in-post-title" value="{{ labels.loading }}" disabled required>
		<p id="post-url">{{ site.url }}/posts/<span>{{ page.post_id }}</span></p>
		{{/ page.is_new }}
		
		<label for="in-post-title">Post Sub-Title <small>(optional)</small></label>
		<input type="text" id="in-post-sub-title" value="{{ labels.loading }}" disabled>

		<div data-flex="row" class="textarea-hat">
			<label for="in-post-markdown">Post Body <sup>*</sup> <small>(GitHub Flavored Markdown +
				<a href="https://katex.org/docs/supported.html" rel="external">KaTeX</a>)</small>
			</label>
			<label for="in-post-markdown-spellcheck">Spell Check</label>
			<input type="checkbox" id="in-post-markdown-spellcheck" checked>
			<label for="in-post-markdown-monospace">Monospace Font</label>
			<input type="checkbox" id="in-post-markdown-monospace" checked>
		</div>
		<textarea id="in-post-markdown" spellcheck="true" placeholder="{{{ page.markdown_textarea_placeholder }}}">{{ labels.loading }}</textarea>
		<div class="controls">
			<div class="left" data-flex="row align-center">
				<button type="submit" id="btn-post-save">Save Post</button>
				<button type="button" id="btn-post-preview" data-style="secondary">Preview</button>
				<button type="reset" id="btn-post-cancel" data-style="secondary">Cancel</button>
			</div>
			<div class="right" data-flex="row align-center">
				<p id="post-publish-status">{{ labels.loading }}</p>
				<button type="button" id="btn-post-toggle-publish" disabled>Publish Post</button>
			</div>
		</div>
	</form>

	<div id="preview" aria-hidden="true" aria-live="polite">
		<button id="btn-post-back-to-edit">Back to Editing</button>
		<markdown-preview title-src="in-post-title" subtitle-src="in-post-sub-title" body-src="in-post-markdown"></markdown-preview>
	</div>
</main>

<script>
{{> markdown_preview }}
</script>

<script>
(() => {

let post_id = '{{ page.post_id }}';
let new_post_id = post_id;

let post;

const main_elem           = document.querySelector('#root > main');
const span_post_url_name  = document.querySelector('#post-url span');
const span_publish_status = document.querySelector('#post-publish-status');

const input_title               = document.querySelector('#in-post-title');
const input_subtitle            = document.querySelector('#in-post-sub-title');
const input_markdown_font       = document.querySelector('#in-post-markdown-monospace');
const input_markdown_spellcheck = document.querySelector('#in-post-markdown-spellcheck');
const textarea_markdown         = document.querySelector('#in-post-markdown');

const btn_toggle_publish = document.querySelector('#btn-post-toggle-publish');
const btn_save           = document.querySelector('#btn-post-save');
const btn_preview        = document.querySelector('#btn-post-preview');
const btn_cancel         = document.querySelector('#btn-post-cancel');
const btn_back_to_edit   = document.querySelector('#btn-post-back-to-edit');

const preview = document.querySelector('markdown-preview');



// ===== Setup event listeners =====

btn_preview.addEventListener('click', () => {
	main_elem.setAttribute('data-preview', '');
	preview.render();
});

btn_back_to_edit.addEventListener('click', () => {
	main_elem.removeAttribute('data-preview');
});

input_title.addEventListener('change', () => {
	on_title_change(input_title.value);
});

input_markdown_spellcheck.addEventListener('change', () => {
	textarea_markdown.setAttribute('spellcheck', input_markdown_spellcheck.checked ? 'true' : 'false');
});

input_markdown_font.addEventListener('change', () => {
	textarea_markdown.classList.toggle('monospace', input_markdown_font.checked);
	textarea_markdown.classList.toggle('no-monospace', ! input_markdown_font.checked);
});



// ===== Start loading data =====

load();



// ===== Utility Functions =====

async function load() {
	if (! post_id) {
		return load_new_post();
	}

	// TODO: Load existing post
}

function load_new_post() {
	textarea_markdown.disabled = false;
	textarea_markdown.innerHTML = '';

	input_subtitle.disabled = false;
	input_subtitle.value = '';

	btn_toggle_publish.disabled = false;
	span_publish_status.innerHTML = 'Post Not Published';

	span_post_url_name.innerHTML = conf.post_uri_format === 'slug' ? '{post_title_slug}' : '{post_snowflake_id}';
}

function on_title_change(new_title) {
	if (conf.post_uri_format === 'slug' && ! post_id) {
		new_post_id = convert_title_to_uri(new_title);
		span_post_url_name.innerHTML = new_post_id;
	}
}

// TODO: More feature-complete URI generator
function convert_title_to_uri(title) {
	return title
		// Remove surrounding whitespace
		.trim()
		// Convert all unallowed characters into spaces
		.replace(/[^a-zA-Z0-9 :]/g, ' ')
		// Collapse all runs of whitespace into a single hyphen
		.replace(/\s+/g, '-')
		// Lowercase
		.toLowerCase();
}

async function cancel_edit() {
	// TODO: Confirm cancel
	// TODO: Navigate back to /posts
}

async function save_post() {
	// 
}

async function publish_post() {
	// TODO: Confirm publish
	// TODO: Disable button / show indication
	// TODO: Publish post
	// TODO: Enable button / change verbage / change message / show indication
}

async function unpublish_post() {
	// TODO: Confirm unpublish
	// TODO: Disable button / show indication
	// TODO: Publish post
	// TODO: Enable button / change verbage / change message / show indication
}

})();
</script>

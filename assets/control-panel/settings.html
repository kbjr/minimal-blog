
<main>
	<h1>{{ labels.pages.settings.title }}</h1>

	<section id="sect-titles">
		<!-- fixme: i18n -->
		<h2>Blog Title / Description</h2>

		<!-- fixme: i18n -->
		<p>
			The title of your blog will be displayed in the title bar of visitors' browsers, as well as
			prominently on the main webpage alongside the description. They should describe the blog as
			a whole, and what kind of content people can expect to find here.
		</p>

		<form>
			<!-- fixme: i18n -->
			<label for="in-title">Title</label>
			<input type="text" id="in-title" required>
			
			<!-- fixme: i18n -->
			<label for="in-subtitle">Sub-Title / Summary / Description</label>
			<input type="text" id="in-subtitle">
			
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-titles" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>
		
	<section id="sect-content-language">
		<!-- fixme: i18n -->
		<h2>Content Language</h2>
		
		<!-- fixme: i18n -->
		<p>
			The content language will be presented in metadata to your visitors' browsers or other
			clients, to inform them of what language to expect content on the site to be written in. It should be an
			<a rel="external" href="https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes">ISO639-1 language code {{{ icons.external-link }}}</a>,
			optionally followed by a dash and an
			<a rel="external" href="https://en.wikipedia.org/wiki/ISO_3166-1">ISO3166-1 alpha-2 country code {{{ icons.external-link }}}</a>.
		</p>

		<form>
			<label for="in-language">Language Code</label>
			<input type="text" id="in-language" placeholder="e.g. &quot;en-us&quot;" required pattern="[a-z]{2}(?:-[a-zA-Z]{2})?">
			
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-language" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>
		
	<section id="sect-control-panel-language">
		<!-- fixme: i18n -->
		<h2>Control Panel Language</h2>
		
		<!-- fixme: i18n -->
		<p>
			This controls the language of text shown here in the control panel UI.
		</p>

		<form>
			<div class="select-box">
				<label for="in-ctrl-language">Language</label>
				<select id="in-ctrl-language">
					<option value="en-us">English (US)</option>
				</select>
			</div>
			
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-ctrl-language" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved. Refresh to see changes" data-success-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>
	
	<section id="sect-copyright-notice">
		<!-- fixme: i18n -->
		<h2>Copyright Notice</h2>

		<!-- fixme: i18n -->
		<p>
			The copyright notice text will be displayed alongside any content on the page, to identify the
			owner of the website's contents.
		</p>

		<form>
			<label for="in-copyright">Copyright Notice</label>
			<input type="text" id="in-copyright" placeholder="e.g. &quot;Copyright 2022 Some Person&quot;">
			
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-copyright" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>
	
	<section id="sect-favicon">
		<!-- fixme: i18n -->
		<h2>Favicon</h2>

		<!-- fixme: i18n -->
		<p>
			A Favicon is an icon image that is often displayed alongside your page, such as in the title bar
			of a web browser. They are typically fairly small and have square dimensions.
		</p>

		<!-- todo: show current favicon -->

		<form>
			<!-- fixme: i18n label -->
			<label for="in-favicon">Upload New Favicon</label>
			<input type="file" accept="image/*" id="in-favicon">
	
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-favicon" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>

	<section id="sect-password">
		<!-- fixme: i18n -->
		<h2>Update Password</h2>

		<p>
			Here you can update the password used to log in to this control panel. You should try to choose a strong
			password (long and complex), one you don't use on other sites or applications, and consider periodically
			updating your password to something new.
		</p>
		
		<form>
			<div class="input-wrapper">
				<!-- fixme: i18n -->
				<label for="in-current-password">Current Password</label>
				<input type="password" id="in-current-password" autocomplete="current-password" required>
			</div>
			
			<div data-flex="row">
				<div class="input-wrapper">
					<!-- fixme: i18n -->
					<label for="in-new-password">New Password</label>
					<input type="password" id="in-new-password" autocomplete="new-password" required minlength="8">
				</div>
				
				<div class="input-wrapper">
					<!-- fixme: i18n -->
					<label for="in-confirm-password">Confirm New Password</label>
					<input type="password" id="in-confirm-password" required>
				</div>
			</div>
	
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-update-password" disabled>Change Password</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Updating..." data-success-message="Password Updated Successfully" data-failure-message="Update Failed"></save-indicator>
			</div>
		</form>
	</section>

	<section id="sect-author">
		<!-- fixme: i18n -->
		<h2>Author Information</h2>

		<p>
			<!--  -->
		</p>
		
		<form>
			<!-- fixme: i18n -->
			<label for="in-author-name">Author Name <sup>*</sup></label>
			<input type="text" id="in-author-name" required>
			
			<!-- fixme: i18n -->
			<label for="in-author-url">Author URL</label>
			<input type="text" id="in-author-url" placeholder="e.g. &quot;https://example.com&quot;">
			
			<!-- fixme: i18n -->
			<label for="in-author-avatar">Author Avatar URL</label>
			<input type="text" id="in-author-avatar" placeholder="e.g. &quot;https://example.com/avatar.png&quot;">
	
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-author" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>

	<section id="sect-uris">
		<!-- fixme: i18n -->
		<h2>Post URIs</h2>

		<!-- fixme: i18n -->
		<p>
			For posts and events, you can choose what type of permalinks are created. "Slug" URIs transform
			the title of the post or event into a URL-safe subset of characters (for example, "My Post Title"
			might result in a permalink URL like <code>{{ site.url }}/posts/my-post-title</code>). The
			"Snowflake" URI option generates a unique
			<a href="https://en.wikipedia.org/wiki/Snowflake_ID">Snowflake ID {{{ icons.external-link }}}</a>
			for each post or event to use in the permalink (for example, your post might have a permalink URL
			like <code>{{ site.url }}/posts/319217064969516516</code> ).
		</p>

		<!-- fixme: i18n -->
		<p role="note">
			Comments, notes, and RSVPs always use snowflakes for their permalinks (because they do not have titles).
		</p>

		<!-- fixme: i18n -->
		<p role="note">
			Changing this setting will change the behavior for new posts and events, but will not change already
			existing permalinks.
		</p>

		<form>
			<div data-flex="row">
				<div class="select-box">
					<!-- fixme: i18n -->
					<label for="in-post-uri-format">Post URI Format</label>
					<select id="in-post-uri-format">
						<!-- fixme: i18n -->
						<option value="slug">Slug</option>
						<option value="snowflake">Snowflake</option>
					</select>
				</div>

				<div class="select-box">
					<!-- fixme: i18n -->
					<label for="in-event-uri-format">Event URI Format</label>
					<select id="in-event-uri-format">
						<!-- fixme: i18n -->
						<option value="slug">Slug</option>
						<option value="snowflake">Snowflake</option>
					</select>
				</div>
			</div>
	
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-uri-format" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>

	<section id="sect-links">
		<!-- fixme: i18n -->
		<h2>Links</h2>

		<!-- fixme: i18n -->
		<p>
			Links are shown by default in the header / sidebar. These are just any links you would like to display
			on your blog to other pages online, typically used for links to personal accounts and profiles on other sites.
		</p>
		<p>
			Each link can have an icon associated to it to be displayed alongside it; Any icon in the
			<a href="https://feathericons.com/" rel="external">Feather icon set {{{ icons.external-link }}}</a> can be used here.
		</p>
		<p>
			Each link can also have a <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel"
			rel="external"><code>rel</code> attribute {{{ icons.external-link }}}</a> associated to it, which is used
			to provide additional metadata to your visitors' browsers or other clients about the relationship
			between your site and the page referenced in the link.
		</p>

		<form id="form-links">
			<table id="table-links">
				<thead>
					<tr>
						<!-- fixme: i18n -->
						<th>Text</th>
						<th>URL</th>
						<th>Icon</th>
						<th><code>rel</code> Value</th>
						<th>Delete Link</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="button" id="btn-links-add-link" disabled>Add Link</button>
				<button type="submit" id="btn-links-save-links" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>
</main>

<script src="{{{ ctrl_panel.url }}}/save_indicator.js"></script>
<script src="{{{ ctrl_panel.url }}}/form.js"></script>
<script>
(() => {

let settings;
let links;

const sect_titles                 = document.querySelector('#sect-titles');
const sect_content_language       = document.querySelector('#sect-content-language');
const sect_control_panel_language = document.querySelector('#sect-control-panel-language');
const sect_copyright_notice       = document.querySelector('#sect-copyright-notice');
const sect_favicon                = document.querySelector('#sect-favicon');
const sect_password               = document.querySelector('#sect-password');
const sect_author                 = document.querySelector('#sect-author');
const sect_uris                   = document.querySelector('#sect-uris');
const sect_links                  = document.querySelector('#sect-links');

const in_title            = document.querySelector('#in-title');
const in_subtitle         = document.querySelector('#in-subtitle');
const btn_titles          = document.querySelector('#btn-titles');
const in_language         = document.querySelector('#in-language');
const btn_language        = document.querySelector('#btn-language');
const in_ctrl_language    = document.querySelector('#in-ctrl-language');
const btn_ctrl_language   = document.querySelector('#btn-ctrl-language');
const in_copyright        = document.querySelector('#in-copyright');
const btn_copyright       = document.querySelector('#btn-copyright');
const in_favicon          = document.querySelector('#in-favicon');
const btn_favicon         = document.querySelector('#btn-favicon');
const in_current_password = document.querySelector('#in-current-password');
const in_new_password     = document.querySelector('#in-new-password');
const in_confirm_password = document.querySelector('#in-confirm-password');
const btn_update_password = document.querySelector('#btn-update-password');
const in_author_name      = document.querySelector('#in-author-name');
const in_author_url       = document.querySelector('#in-author-url');
const in_author_avatar    = document.querySelector('#in-author-avatar');
const btn_author          = document.querySelector('#btn-author');
const in_post_uri_format  = document.querySelector('#in-post-uri-format');
const in_event_uri_format = document.querySelector('#in-event-uri-format');
const btn_uri_format      = document.querySelector('#btn-uri-format');
const btn_add_link        = document.querySelector('#btn-links-add-link');
const tbody_links         = document.querySelector('#table-links tbody');

const form_titles                 = new app.Form(sect_titles.querySelector('form'), submit_titles);
const form_content_language       = new app.Form(sect_content_language.querySelector('form'), submit_content_language);
const form_control_panel_language = new app.Form(sect_control_panel_language.querySelector('form'), submit_control_panel_language);
const form_copyright_notice       = new app.Form(sect_copyright_notice.querySelector('form'), submit_copyright_notice);
const form_favicon                = new app.Form(sect_favicon.querySelector('form'), submit_favicon);
const form_password               = new app.Form(sect_password.querySelector('form'), submit_password);
const form_author                 = new app.Form(sect_author.querySelector('form'), submit_author);
const form_uris                   = new app.Form(sect_uris.querySelector('form'), submit_post_uris);
const form_links                  = new app.Form(sect_links.querySelector('form'), submit_links);



// 

btn_add_link.addEventListener('click', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();
	add_link('', '', 'external-link', '');
	return false;
});



// 

load();




// 

async function load() {
	disable_all();
	[ settings, links ] = await Promise.all([
		app.http_get('/api/settings', true),
		app.http_get('/api/links', true),
	]);
	set_initial_values();
	enable_all();
}

function disable_all() {
	form_titles.disable();
	form_content_language.disable();
	form_control_panel_language.disable();
	form_copyright_notice.disable();
	form_favicon.disable();
	form_password.disable();
	form_author.disable();
	form_uris.disable();
	form_links.disable();
}

function enable_all() {
	form_titles.enable(false);
	form_content_language.enable(false);
	form_control_panel_language.enable(false);
	form_copyright_notice.enable(false);
	form_favicon.enable(false);
	form_password.enable(false);
	form_author.enable(false);
	form_uris.enable(false);
	form_links.enable(false);
}

function set_initial_values() {
	in_title.value = settings.feed_title;
	in_subtitle.value = settings.feed_description;
	in_language.value = settings.language;
	in_ctrl_language.value = settings.ctrl_panel_language;
	in_copyright.value = settings.copyright_notice;
	// todo: display favicon
	in_author_name.value = settings.author_name;
	in_author_url.value = settings.author_url;
	in_author_avatar.value = settings.author_avatar;
	in_post_uri_format.value = settings.post_uri_format;
	in_event_uri_format.value = settings.event_uri_format;

	for (const link of links) {
		add_link(link.label, link.link_url, link.icon, link.rel);
	}
}



// 

function add_link(text, url, icon, rel) {
	const tr = document.createElement('tr');
	tr.innerHTML = link_row_html;

	tbody_links.appendChild(tr);
	
	const in_text = tr.querySelector('.link-text input');
	const in_url = tr.querySelector('.link-url input');
	const in_icon = tr.querySelector('.link-icon select');
	const in_rel = tr.querySelector('.link-rel input');
	const btn_delete = tr.querySelector('.link-delete button');

	in_text.value = text;
	in_url.value = url;
	in_icon.value = icon;
	in_rel.value = rel;
	
	in_text.addEventListener('change', form_links.on_change);
	in_url.addEventListener('change', form_links.on_change);
	in_icon.addEventListener('change', form_links.on_change);
	in_rel.addEventListener('change', form_links.on_change);
	btn_delete.addEventListener('click', on_delete_link);
	
	return { tr, in_text, in_url, in_icon, in_rel, btn_delete };
}

// fixme: i18n on placeholders
const link_row_html = `
<td class="link-text"><input type="text" placeholder="e.g. &quot;My Other Website&quot;" required></td>
<td class="link-url"><input type="text" placeholder="e.g. &quot;https://example.com&quot;" required></td>
<td class="link-icon">
	<select>
		{{# icon_names }}
		<option value="{{ . }}">{{ . }}</option>
		{{/ icon_names }}
	</select>
</td>
<td class="link-rel"><input type="text" placeholder="e.g. &quot;me&quot; or &quot;external&quot;"></td>
<td class="link-delete">
	<button type="button" title="Delete Link" class="icon-only">{{{ icons.trash }}}</button>
</td>
`;

function on_delete_link(event) {
	form_links.on_change(event);
	const button = event.target;
	const td = button.parentElement;
	const tr = td.parentElement;
	tr.parentElement.removeChild(tr);
}



// 

async function submit_titles() {
	const title = in_title.value;
	const subtitle = in_subtitle.value;
	const patch = {
		feed_title: title,
		feed_description: subtitle,
	};

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_content_language() {
	const language = in_language.value;
	const patch = { language };

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_control_panel_language() {
	const ctrl_panel_language = in_ctrl_language.value;
	const patch = { ctrl_panel_language };

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_copyright_notice() {
	const copyright_notice = in_copyright.value;
	const patch = { copyright_notice };

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_favicon() {
	/** @type {File} */
	const file = in_favicon.files[0];

	if (! file) {
		throw app.FormSubmitError('No file selected');
	}

	const headers = app.http_headers(true, {
		'content-type': file.type
	});

	const contents = await file.arrayBuffer();
	await app.http('PUT', '/api/settings/favicon', headers, contents);
	in_favicon.value = '';
	// todo: update favicon preview
}

async function submit_password() {
	const current_password = in_current_password.value;
	const new_password = in_new_password.value;
	const confirm_password = in_confirm_password.value;
		
	if (new_password !== confirm_password) {
		// fixme: i18n
		throw new app.FormSubmitError('Password and confirmation do not match');
	}

	await app.http_put('/api/settings/password', true, {
		current_password,
		new_password
	});

	in_current_password.value = '';
	in_new_password.value = '';
	in_confirm_password.value = '';
}

async function submit_author() {
	const author_name = in_author_name.value;
	const author_url = in_author_url.value;
	const author_avatar = in_author_avatar.value;
	const patch = {
		author_name,
		author_url,
		author_avatar,
	};

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_post_uris() {
	const post_uri_format = in_post_uri_format.value;
	const event_uri_format = in_event_uri_format.value;
	const patch = {
		post_uri_format,
		event_uri_format,
	};

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_links() {
	const rows = tbody_links.querySelectorAll('tr');
	const new_links = [ ];

	for (const row of rows) {
		const label = row.querySelector('.link-text input').value;
		const link_url = row.querySelector('.link-url input').value;
		const icon = row.querySelector('.link-icon select').value;
		const rel = row.querySelector('.link-rel input').value;
		new_links.push({ label, link_url, icon, rel });
	}

	await app.http_put('/api/links', true, new_links);
	links.length = 0;
	links.push(...new_links);
}

})();
</script>

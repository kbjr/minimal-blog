
<main>
	<form id="form-login">
		<p>Login to continue</p>
		
		<label for="in-password">Password</label>
		<input type="password" id="in-password" required autocomplete="current-password">
	
		<button type="submit" id="btn-login">Login</button>
	</form>
</main>

<script>
(() => {

const form           = document.querySelector('#form-login');
const input_password = form.querySelector('#in-password');
const button_submit  = form.querySelector('#btn-login');

form.addEventListener('submit', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();

	const password = document.querySelector('#in-password').value;

	disable_form();
	login(password);

	return false;
});

input_password.addEventListener('change', () => {
	button_submit.setCustomValidity('');
});

async function login(password) {
	const headers = app.http_headers(true, {
		'content-type': 'application/json'
	});

	const body = JSON.stringify({ password });
	const res = await app.http('POST', '/api/token', headers, body);

	switch (res.status) {
		case 200: {
			const json = await res.json();
			app.login(json.token, json.payload, true);
			break;
		};

		case 401:
		case 422:
		default: {
			let message;

			try {
				message = (await res.json()).error;
			}

			catch (error) { }

			message = message || 'Something went wrong';

			console.error(message);
			button_submit.setCustomValidity(message);
			button_submit.reportValidity();

			enable_form();
			break;
		};
	}
}

function disable_form() {
	input_password.disabled = true;
	button_submit.disabled = true;
}

function enable_form() {
	input_password.disabled = false;
	button_submit.disabled = false;
}
	
})();
</script>

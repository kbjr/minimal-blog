
<main>
	<h1>{{ labels.pages.mention_settings.title }}</h1>

	<section>
		<!-- fixme: i18n -->
		<h2>Enable Mentions</h2>
		<!-- fixme: i18n -->
		<p>
			"Mentions" refers to when one page on the internet links to another and sends a notification to the referenced page.
			You might receive these when someone comments on or replies to your posts, or RSVPs to your events. You can also send
			them automatically yourself when you mention other people's content to let them know about your replies.
		</p>
		<!-- fixme: i18n -->
		<p>
			Two common standards for sending and receiving these notifications are
			<a href="https://www.hixie.ch/specs/pingback/pingback" rel="external">Pingbacks {{{ icons.external-link }}}</a>
			and <a href="https://www.w3.org/TR/webmention" rel="external">WebMentions {{{ icons.external-link }}}</a>. These settings
			control whether or not your blog sends and receives notifications of either type.
		</p>
		<form id="form-enable-mentions" aria-busy="true" aria-live="polite">
			<div data-flex="row" class="inputs">
				<fieldset id="fs-enable-pingbacks">
					<!-- fixme: i18n -->
					<legend>Pingbacks</legend>
					
					<div class="checkbox">
						<!-- fixme: i18n -->
						<input type="checkbox" id="in-enable-send-pingbacks">
						<label for="in-enable-send-pingbacks">Send Pingbacks</label>
					</div>
					
					<div class="checkbox">
						<!-- fixme: i18n -->
						<input type="checkbox" id="in-enable-receive-pingbacks">
						<label for="in-enable-receive-pingbacks">Receive Pingbacks</label>
					</div>
				</fieldset>
				
				<fieldset id="fs-enable-webmentions">
					<!-- fixme: i18n -->
					<legend>WebMentions</legend>
					
					<div class="checkbox">
						<!-- fixme: i18n -->
						<input type="checkbox" id="in-enable-send-webmentions">
						<label for="in-enable-send-webmentions">Send WebMentions</label>
					</div>
					
					<div class="checkbox">
						<!-- fixme: i18n -->
						<input type="checkbox" id="in-enable-receive-webmentions">
						<label for="in-enable-receive-webmentions">Receive WebMentions</label>
					</div>
				</fieldset>
			</div>

			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-enable-mentions" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved"></save-indicator>
			</div>
		</form>
	</section>

	<section>
		<!-- fixme: i18n -->
		<h2>HTTPS Only</h2>
		<form id="form-https-only">
			<!-- fixme: i18n -->
			<p id="desc-https-only">
				To verify a mention that has been received, a request has to be made from your blog to the URL in
				the notification. If you would prefer your blog not make requests to insecure websites, you can enable
				HTTPS-only; This will result in all notifications from insecure sites being automatically blocked.
			</p>
					
			<div class="checkbox">
				<!-- fixme: i18n -->
				<input type="checkbox" id="in-https-only" aria-describedby="desc-https-only">
				<label for="in-https-only">HTTPS Only</label>
			</div>

			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-https-only" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved"></save-indicator>
			</div>
		</form>
	</section>

	<section>
		<!-- fixme: i18n -->
		<h2>Auto-Moderation Defaults</h2>
		<p>
			These are the auto-moderation default behaviors for mentions you receive. These apply to any mentions
			from any source that doesn't have a more specific moderation rule applied to it. 
		</p>
		<dl>
			<dt>Allow</dt>
			<dd>Mentions from unknown sources are automatically approved and displayed.</dd>
			
			<dt>Block</dt>
			<dd>Mentions from unknown sources are blocked.</dd>
			
			<dt>Review</dt>
			<dd>Mentions from unknown sources are sent to the Moderation Queue for review before displaying.</dd>
		</dl>
		<form id="form-mentions-defaults" aria-busy="true" aria-live="polite">
			<div data-flex="row" class="inputs">
				<div class="select-box">
					<!-- fixme: i18n -->
					<label for="in-pingback-default">Pingback Default</label>
					<!-- fixme: i18n -->
					<select id="in-pingback-default">
						<option value="allow">Allow</option>
						<option value="block">Block</option>
						<option value="review">Review</option>
					</select>
				</div>

				<div class="select-box">
					<!-- fixme: i18n -->
					<label for="in-webmention-default">WebMention Default</label>
					<!-- fixme: i18n -->
					<select id="in-webmention-default">
						<option value="allow">Allow</option>
						<option value="block">Block</option>
						<option value="review">Review</option>
					</select>
				</div>
			</div>

			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="submit" id="btn-mentions-defaults" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved"></save-indicator>
			</div>
		</form>
	</section>

	<section>
		<!-- fixme: i18n -->
		<h2>Auto-Moderation Rules</h2>
		<!-- fixme: i18n -->
		<p>
			These rules enable you to override the above default behavior for mentions coming from specific sources.
			This can be used to automatically allow trusted sources to post comments without needing approvals, or to
			block comments from sources you don't trust.
		</p>
		<dl>
			<!-- fixme: i18n -->
			<dt>Allow</dt>
			<dd>Mentions from the given source are automatically approved and displayed.</dd>
			
			<!-- fixme: i18n -->
			<dt>Block</dt>
			<dd>Mentions from the given source are blocked.</dd>
			
			<!-- fixme: i18n -->
			<dt>Review</dt>
			<dd>Mentions from the given source are sent to the Moderation Queue for review before displaying.</dd>
		</dl>
		<form id="form-mentions-rules">
			<table id="table-mentions-rules" aria-busy="true" aria-live="polite">
				<thead>
					<tr>
						<!-- fixme: i18n -->
						<th class="rule-source">Source Prefix</th>
						<th class="rule-pingback">Pingbacks</th>
						<th class="rule-webmention">WebMentions</th>
						<th class="rule-notes">Notes</th>
						<th class="rule-delete">Delete</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
			<div data-flex="row align-center" class="buttons">
				<!-- fixme: i18n label -->
				<button type="button" id="btn-mentions-add-rule" disabled>Add Rule</button>
				<button type="submit" id="btn-mentions-save-rules" disabled>Save Changes</button>
				<!-- fixme: i18n label -->
				<save-indicator data-active-message="Saving..." data-success-message="Saved" data-failure-message="Save Failed"></save-indicator>
			</div>
		</form>
	</section>
</main>

<script src="{{{ ctrl_panel.url }}}/save_indicator.js"></script>
<script src="{{{ ctrl_panel.url }}}/form.js"></script>
<script>
(() => {

let settings;
let moderation_rules;

const fs_enable_pingbacks           = document.querySelector('#fs-enable-pingbacks');
const in_enable_send_pingbacks      = document.querySelector('#in-enable-send-pingbacks');
const in_enable_receive_pingbacks   = document.querySelector('#in-enable-receive-pingbacks');
const fs_enable_webmentions         = document.querySelector('#fs-enable-webmentions');
const in_enable_send_webmentions    = document.querySelector('#in-enable-send-webmentions');
const in_enable_receive_webmentions = document.querySelector('#in-enable-receive-webmentions');
const btn_enable_mentions           = document.querySelector('#btn-enable-mentions');
const desc_https_only               = document.querySelector('#desc-https-only');
const in_https_only                 = document.querySelector('#in-https-only');
const btn_https_only                = document.querySelector('#btn-https-only');
const in_pingback_default           = document.querySelector('#in-pingback-default');
const in_webmention_default         = document.querySelector('#in-webmention-default');
const btn_mentions_defaults         = document.querySelector('#btn-mentions-defaults');
const table_mentions_rules          = document.querySelector('#table-mentions-rules');
const tbody_rules                   = table_mentions_rules.querySelector('tbody');
const btn_mentions_add_rule         = document.querySelector('#btn-mentions-add-rule');
const btn_mentions_save_rules       = document.querySelector('#btn-mentions-save-rules');

// 
const form_enable_mentions   = new app.Form(document.querySelector('#form-enable-mentions'), submit_enable_mentions);
const form_https_only        = new app.Form(document.querySelector('#form-https-only'), submit_https_only);
const form_mentions_defaults = new app.Form(document.querySelector('#form-mentions-defaults'), submit_mentions_defaults);
const form_mentions_rules    = new app.Form(document.querySelector('#form-mentions-rules'), submit_mentions_rules);

load();

btn_mentions_add_rule.addEventListener('click', (event) => {
	event.preventDefault();
	event.stopImmediatePropagation();
	add_rule('', '', '', '');
	return false;
});




// 

async function load() {
	disable_all();
	settings = await app.http_get('/api/settings', true);
	moderation_rules = [{
		source: 'https://blog.jbrumond.me',
		pingback: null,
		webmention: 'allow',
		notes: 'Me :)'
	}];
	// moderation_rules = await app.http_get('/api/moderation_rules', true);
	set_initial_values();
	enable_all();
}

function disable_all() {
	form_enable_mentions.disable();
	form_https_only.disable();
	form_mentions_defaults.disable();
	form_mentions_rules.disable();
}

function enable_all() {
	form_enable_mentions.enable(false);
	form_https_only.enable(false);
	form_mentions_defaults.enable(false);
	form_mentions_rules.enable(false);
}

function set_initial_values() {
	in_enable_send_pingbacks.checked = settings.send_pingback;
	in_enable_receive_pingbacks.checked = settings.receive_pingback;
	in_enable_send_webmentions.checked = settings.send_webmention;
	in_enable_receive_webmentions.checked = settings.receive_webmention;
	in_https_only.checked = settings.https_only;
	in_pingback_default.value = settings.default_pingback;
	in_webmention_default.value = settings.default_webmention;
	
	for (const rule of moderation_rules) {
		add_rule(rule.source, rule.pingback, rule.webmention, rule.notes);
	}
}



// 

function add_rule(source, pingback, webmention, notes) {
	const tr = document.createElement('tr');
	tr.innerHTML = rule_row_html;

	tbody_rules.appendChild(tr);
	
	const in_source = tr.querySelector('.rule-source input');
	const in_pingback = tr.querySelector('.rule-pingback select');
	const in_webmention = tr.querySelector('.rule-webmention select');
	const in_notes = tr.querySelector('.rule-notes input');
	const btn_delete = tr.querySelector('.rule-delete button');

	in_source.value = source;
	in_pingback.value = pingback || '';
	in_webmention.value = webmention || '';
	in_notes.value = notes;
	
	in_source.addEventListener('change', form_mentions_rules.on_change);
	in_pingback.addEventListener('change', form_mentions_rules.on_change);
	in_webmention.addEventListener('change', form_mentions_rules.on_change);
	in_notes.addEventListener('change', form_mentions_rules.on_change);
	btn_delete.addEventListener('click', on_delete_rule);
	
	return { tr, in_source, in_pingback, in_webmention, in_notes, btn_delete };
}

// fixme: i18n on placeholders
const rule_row_html = `
<td class="rule-source"><input type="text" placeholder="e.g. &quot;https://example.com&quot;"></td>
<td class="rule-pingback">
	<select>
		<!-- fixme: i18n -->
		<option value="">Default</option>
		<option value="allow">Allow</option>
		<option value="block">Block</option>
		<option value="review">Review</option>
	</select>
</td>
<td class="rule-webmention">
	<select>
		<!-- fixme: i18n -->
		<option value="">Default</option>
		<option value="allow">Allow</option>
		<option value="block">Block</option>
		<option value="review">Review</option>
	</select>
</td>
<td class="rule-notes">
	<input type="text">
</td>
<td class="rule-delete">
	<button title="Delete Rule" class="icon-only">{{{ icons.trash }}}</button>
</td>
`;

function on_delete_rule(event) {
	form_mentions_rules.on_change(event);
	const button = event.target;
	const td = button.parentElement;
	const tr = td.parentElement;
	tr.parentElement.removeChild(tr);
}




// 

async function submit_enable_mentions() {
	const send_pingback = in_enable_send_pingbacks.checked;
	const receive_pingback = in_enable_receive_pingbacks.checked;
	const send_webmention = in_enable_send_webmentions.checked;
	const receive_webmention = in_enable_receive_webmentions.checked;
	const patch = {
		send_pingback,
		receive_pingback,
		send_webmention,
		receive_webmention,
	};

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_https_only() {
	const https_only = in_https_only.checked;
	const patch = {
		https_only,
	};

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_mentions_defaults() {
	const default_pingback = in_pingback_default.value;
	const default_webmention = in_webmention_default.value;
	const patch = {
		default_pingback,
		default_webmention,
	};

	await app.http_patch('/api/settings', true, patch);
	Object.assign(settings, patch);
}

async function submit_mentions_rules() {
	const trs = table_mentions_rules.querySelectorAll('tbody tr');
	const new_rules = [ ];

	for (const tr of trs) {
		const in_source = tr.querySelector('.rule-source input');
		const in_pingback = tr.querySelector('.rule-pingback select');
		const in_webmention = tr.querySelector('.rule-webmention select');
		const in_notes = tr.querySelector('.rule-notes input');

		new_rules.push({
			source: in_source.value,
			pingback: in_pingback.value || null,
			webmention: in_webmention.value || null,
			notes: in_notes.value,
		});
	}

	await app.http_put('/api/moderation_rules', true, new_rules);
	moderation_rules = new_rules;
}

})();
</script>
	